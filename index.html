<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Feodalis – Carte interactive</title>

<style>
/* =========================
   BASE
========================= */
html,body{
  margin:0;
  padding:0;
  background:#0f2a3a;
  font-family:serif;
}

#map-wrapper{
  width:100%;
  display:flex;
  justify-content:center;
  padding:10px;
  box-sizing:border-box;
}

#map-container{
  position:relative;
  width:min(95vw,1100px);
}

#map-image{
  display:block;
  width:100%;
  height:auto;
}

/* Couche au-dessus de la carte */
#markers-layer{
  position:absolute;
  inset:0;
  pointer-events:none;
}

/* =========================
   MARQUEURS (BLASONS)
========================= */
.marker{
  position:absolute;
  width:clamp(28px,6vw,90px);
  height:clamp(28px,6vw,90px);
  transform:translate(-50%,-50%);
  cursor:pointer;
  pointer-events:auto;
}
.marker img{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* =========================
   HOTSPOT CACHÉ SUR LE "A"
   (zone cliquable minuscule)
========================= */
.hotspot{
  position:absolute;
  pointer-events:auto;
  cursor:pointer;
  background:transparent;
}

/* =========================
   BULLE (TOOLTIP)
========================= */
.tooltip{
  position:absolute;
  background:#6b4a2d;
  color:#f5e6c8;
  border-radius:12px;
  padding:clamp(6px,2vw,10px) clamp(8px,3vw,12px);
  font-size:clamp(11px,3vw,14px);
  max-width:clamp(210px,78vw,340px);
  box-shadow:0 6px 16px rgba(0,0,0,.4);
  z-index:999;

  display:none;
  pointer-events:auto;
  overflow-wrap:anywhere;
  word-break:break-word;

  width:var(--tip-w, auto);
  height:var(--tip-h, auto);
  box-sizing:border-box;

  flex-direction:column;
  transform:translateX(-50%);

  --arrow-x:50%;
  --arrow-y:50%;
}

/* Flèche (V) */
.tooltip::after{
  content:"";
  position:absolute;
  border-style:solid;
}

/* V en bas (bulle au-dessus) */
.tooltip:not(.below):not(.arrow-left):not(.arrow-right)::after{
  left:var(--arrow-x);
  transform:translateX(-50%);
  bottom:-8px;
  border-width:8px 8px 0 8px;
  border-color:#6b4a2d transparent transparent transparent;
}

/* V en haut (bulle en dessous) */
.tooltip.below:not(.arrow-left):not(.arrow-right)::after{
  left:var(--arrow-x);
  transform:translateX(-50%);
  top:-8px;
  border-width:0 8px 8px 8px;
  border-color:transparent transparent #6b4a2d transparent;
}

/* V à gauche */
.tooltip.arrow-left::after{
  top:var(--arrow-y);
  transform:translateY(-50%);
  left:-8px;
  border-width:8px 8px 8px 0;
  border-color:transparent #6b4a2d transparent transparent;
}

/* V à droite */
.tooltip.arrow-right::after{
  top:var(--arrow-y);
  transform:translateY(-50%);
  right:-8px;
  border-width:8px 0 8px 8px;
  border-color:transparent transparent transparent #6b4a2d;
}

/* =========================
   CONTENU BULLE
========================= */
.tip-header{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}
.tip-title{font-weight:bold;}
.tip-sub{font-size:clamp(10px,2.6vw,12px);line-height:1.2;opacity:.95;}

.tip-divider{
  height:1px;
  background:rgba(255,255,255,0.2);
  margin:6px 0;
}

.tip-grid{
  display:grid;
  grid-template-columns:auto 1fr;
  gap:4px 8px;
  font-size:clamp(11px,2.8vw,13px);
}
.k{opacity:.9;}
.v{text-align:right;font-weight:bold;color:#fff2cf;}

.tip-body{
  flex:1;
  display:flex;
  flex-direction:column;
}

.tip-nav{
  margin-top:auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding-top:8px;
  gap:10px;
}

.tip-btn{
  background:rgba(255,255,255,.15);
  border:1px solid rgba(255,255,255,.2);
  color:#f5e6c8;
  border-radius:8px;
  padding:clamp(4px,2vw,6px) clamp(6px,3vw,9px);
  font-size:clamp(9px,2.6vw,10px);
  cursor:pointer;
  user-select:none;
}
.tip-btn:disabled{opacity:.4;cursor:not-allowed;}
.tip-page{font-size:clamp(10px,2.6vw,12px);opacity:.9;}
</style>
</head>

<body>

<div id="map-wrapper">
  <div id="map-container">
    <img id="map-image" src="carte.png" alt="Carte Feodalis">
    <div id="markers-layer">

      <!-- EXEMPLE DE MARQUEUR -->
      <div class="marker" style="left:19.73%; top:48.93%;" data-maison="Léda">
        <img src="Leda.png" alt="Léda">
      </div>

      <!-- ZONE CLIQUABLE MINUSCULE SUR LE "A" DU LOGO FEODALIS -->
      <!-- Ajuste légèrement left/top si besoin -->
      <div id="logo-hotspot" class="hotspot"
           style="left:88.6%; top:11.2%; width:1.2%; height:1.8%;"></div>

      <!-- Bulle -->
      <div id="tooltip" class="tooltip"></div>
    </div>
  </div>
</div>

<script>
/* ======================================================
   CONSTANTES DE POSITIONNEMENT
   GAP = distance entre blason et bulle (réduite de moitié)
   ARROW = taille du V (augmentée d’environ 30%)
====================================================== */
const ARROW = 8;   // anciennement 6
const GAP   = 7;   // anciennement 14
const PADDING = 8;

/* Lien secret (ticket RDD) */
const SECRET_LINK = "https://www.youtube.com/watch?v=dQw4w9WgXcQ&list=RDdQw4w9WgXcQ&start_radio=1";

/* ======================================================
   ÉLÉMENTS DOM
====================================================== */
const tooltip = document.getElementById("tooltip");
const map = document.getElementById("map-container");
const logoHotspot = document.getElementById("logo-hotspot");

/* ======================================================
   ANCRAGE ACTUEL DE LA BULLE
====================================================== */
let anchor = {x:0, y:0, halfW:0, halfH:0};

/* ======================================================
   POSITIONNEMENT
====================================================== */
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

/* Calcule l’ancrage depuis un marqueur */
function computeAnchorFromMarker(marker){
  const m = marker.getBoundingClientRect();
  const c = map.getBoundingClientRect();
  anchor.x = (m.left - c.left) + m.width/2;
  anchor.y = (m.top  - c.top ) + m.height/2;
  anchor.halfW = m.width/2;
  anchor.halfH = m.height/2;
}

/* Calcule l’ancrage depuis le hotspot du A */
function computeAnchorFromHotspot(el){
  const r = el.getBoundingClientRect();
  const c = map.getBoundingClientRect();
  anchor.x = (r.left - c.left) + r.width/2;
  anchor.y = (r.top  - c.top ) + r.height/2;
  anchor.halfW = r.width/2;
  anchor.halfH = r.height/2;
}

/* Place la bulle correctement */
function placeTooltip(){
  const mapRect = map.getBoundingClientRect();

  const markerTop = anchor.y - anchor.halfH;
  const markerBot = anchor.y + anchor.halfH;

  /* On préfère afficher au-dessus, sinon en dessous */
  const canAbove = (markerTop - tooltip.offsetHeight - (ARROW+GAP)) >= PADDING;
  const below = !canAbove;
  tooltip.classList.toggle("below", below);

  tooltip.classList.remove("arrow-left","arrow-right");

  const minCenter = tooltip.offsetWidth/2 + PADDING;
  const maxCenter = mapRect.width - tooltip.offsetWidth/2 - PADDING;

  let baseX = clamp(anchor.x, minCenter, maxCenter);

  let top = below
    ? (markerBot + (ARROW+GAP))
    : (markerTop - tooltip.offsetHeight - (ARROW+GAP));

  tooltip.style.left = baseX + "px";
  tooltip.style.top  = top + "px";
  tooltip.style.display = "flex";

  const visualLeft = baseX - tooltip.offsetWidth/2;
  let arrowX = anchor.x - visualLeft;
  arrowX = clamp(arrowX, 12, tooltip.offsetWidth - 12);
  tooltip.style.setProperty("--arrow-x", arrowX + "px");
}

/* ======================================================
   CONTENU DE LA BULLE
====================================================== */
function buildSecretTooltip(){
  return `
    <div class="tip-header">
      <div>
        <div class="tip-title">Feodalis</div>
        <div class="tip-sub">Ticket secret</div>
      </div>
    </div>
    <div class="tip-divider"></div>
    <div class="tip-body">
      <div style="line-height:1.3">
        Bravo, tu as trouvé un ticket de la RDD.<br>
        Pour le récupérer, 
        <a href="${SECRET_LINK}" target="_blank" style="color:#fff2cf;text-decoration:underline">
          clique ici
        </a>.
      </div>
    </div>
  `;
}

/* ======================================================
   INTERACTIONS
====================================================== */

/* Clic sur le A du logo */
logoHotspot.addEventListener("click", e=>{
  e.stopPropagation();
  computeAnchorFromHotspot(logoHotspot);
  tooltip.innerHTML = buildSecretTooltip();
  tooltip.style.display = "flex";
  placeTooltip();
});

/* Fermer la bulle si on clique ailleurs */
document.addEventListener("click", ()=>{
  tooltip.style.display = "none";
});
</script>

</body>
</html>
